<!DOCTYPE html>
<html>
  <head>
    <title>Vote</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.3/css/pico.min.css">
    <style>
      .choice {
          user-select: none;
          cursor: grab;
      }
    </style>
  </head>
  <script>
    function describe_vote(choices, vote) {
      let s = `${vote.name}: `;
      for (let j = 0; j < vote.selections.length; j++) {
        let vi = vote.selections[j];
        if (j != 0) {
          if (vote.selections[j].rank != vote.selections[j - 1].rank) {
            s += " > ";
          } else {
            s += " = ";
          }
        }
        s += choices[vi.candidate];
      }
      return s;
    }

    function init() {
        let url = new URL(document.location);
        let room = url.searchParams.get('room');
        if (room == null) {
          document.getElementById("setup").hidden = false;
          return;
        }

        let elements = {};
        [
            "status", "setup", "election", "choices", "submitted_outer",
            "submitted", "num_players", "submit", "num_votes", "tally",
            "results", "winner", "defeats_matrix", "votes", "new", "voter_name",
            "your_vote", "your_vote_outer",
        ].forEach(
            name => {
                elements[name] = document.getElementById(name);
            }
        );

        elements.new.hidden = false;
        elements.status.hidden = false;

        let ws_protocol;
        if (window.location.protocol != "https:") {
            ws_protocol = "ws://";
        } else {
            ws_protocol = "wss://";
        }
        const uri = ws_protocol + location.host + '/vote/ws/' + room;
        const ws = new WebSocket(uri);

        let state = {"status": "connecting"};

        ws.onclose = function() {
          if (state.status != "invalid_room") {
            state.status = "disconnected";
            elements.status.textContent = 'Disconnected from server! Try refreshing.';
            elements.status.style.color = "red";
          }
        };

        ws.onmessage = function(msg) {
          const new_state = JSON.parse(msg.data);
          console.log(new_state);
          if (new_state.status == "connected") {
            elements.election.hidden = !!new_state.vote.results;
            elements.status.textContent = "Connected!";
            elements.num_players.textContent = new_state.vote.num_players;
            elements.num_votes.textContent = new_state.vote.num_votes;
            if (new_state.vote.your_vote) {
              elements.tally.hidden = false;
            }

            if (elements.choices.hidden) {
              elements.choices.hidden = false;
              for (let i = 0; i < new_state.vote.choices.length; i++) {
                let choice = document.createElement("a");
                choice.setAttribute("href", "#");
                choice.setAttribute("role", "button");
                choice.setAttribute("class", "choice outline");
                choice.dataset.choice_id = i;
                choice.textContent = new_state.vote.choices[i];
                elements.choices.append(choice);
                if (i + 1 != new_state.vote.choices.length) {
                  let order_element = document.createElement("a");
                  order_element.setAttribute("href", "#");
                  order_element.setAttribute("role", "button");
                  order_element.setAttribute("class", "ordering secondary outline");
                  order_element.textContent = ">";
                  elements.choices.append(order_element);
                }
              }

              // Drag-to-swap ballot items.
              let selected = null;
              function select(elem) {
                if (selected) {
                  selected.classList.remove("contrast");
                }
                selected = elem;
                selected.classList.add("contrast");
              }
              function deselect() {
                if (selected) {
                  selected.classList.remove("contrast");
                }
                selected = null;
              }
              function swap(elem1, elem2) {
                let a = elem1.nextSibling;
                elem2.parentNode.insertBefore(elem1, elem2.nextSibling);
                elem2.parentNode.insertBefore(elem2, a);
              }
              function on_drag_start(e) {
                select(e.target);
              }
              function on_drag_over(e) {
                swap(selected, e.target);
              }
              function on_click(e) {
                if (selected == null) {
                  select(e.target);
                } else {
                  swap(selected, e.target);
                  deselect();
                }
              }
              elements.choices.querySelectorAll(".choice").forEach(function (item) {
                item.draggable = true;
                item.ondragstart = on_drag_start;
                item.ondragover = on_drag_over;
                item.onclick = on_click;
              });

              // Click-to-edit ballot ordering.
              elements.choices.querySelectorAll(".ordering").forEach(function(item) {
                item.onclick = function() {
                  if (item.textContent == ">" || item.textContent == "&gt;") {
                    item.textContent = "=";
                  } else {
                    item.textContent = ">";
                  }
                }
              });
            }

            elements.your_vote_outer.hidden = !new_state.vote.your_vote;
            if (new_state.vote.your_vote) {
              elements.your_vote.textContent = describe_vote(new_state.vote.choices, new_state.vote.your_vote);
            }

            if (new_state.vote.results) {
              elements.results.hidden = false;
              elements.winner.textContent = new_state.vote.results.tally.winners.map(w => new_state.vote.choices[w]).join(" AND ");

              let vote_elements = [];
              for (let i = 0; i < new_state.vote.results.votes.length; i++) {
                let vote = new_state.vote.results.votes[i];
                let elem = document.createElement("li");
                elem.textContent = describe_vote(new_state.vote.choices, vote);
                vote_elements.push(elem);
              }
              elements.votes.replaceChildren(...vote_elements)

              let thead = document.createElement("thead");
              let header_row = document.createElement("tr");
              let topleft_th = document.createElement("th");
              topleft_th.setAttribute("scope", "col");
              let header_row_children = [topleft_th];
              for (const choice of new_state.vote.choices) {
                let header_row_item = document.createElement("th");
                header_row_item.setAttribute("scope", "col");
                header_row_item.textContent = choice;
                header_row_children.push(header_row_item);
              }
              header_row.replaceChildren(...header_row_children);
              thead.replaceChildren(header_row);
              const totals = new_state.vote.results.tally.totals;
              let tbody_children = [];
              for (let i = 0; i < totals.length; i++) {
                let choice_elem = document.createElement("th");
                choice_elem.setAttribute("scope", "row");
                choice_elem.textContent = new_state.vote.choices[i];
                let row_elements = [choice_elem];
                for (let j = 0; j < totals[i].length; j++) {
                  let elem = document.createElement("td");
                  if (totals[i][j] > totals[j][i]) {
                    let inner_elem = document.createElement("mark");
                    inner_elem.textContent = totals[i][j];
                    elem.replaceChildren(inner_elem);
                  } else if (i == j) {
                    elem.textContent = "-";
                  } else {
                    elem.textContent = totals[i][j];
                  }
                  row_elements.push(elem);
                }
                let row_elem = document.createElement("tr");
                row_elem.replaceChildren(...row_elements);
                tbody_children.push(row_elem);
              }
              let tbody = document.createElement("tbody");
              tbody.replaceChildren(...tbody_children);
              elements.defeats_matrix.replaceChildren(thead, tbody);
            }
          } else if (new_state.status == "invalid_room") {
            elements.status.textContent = "Invalid room. Go back and create a game.";
            url.searchParams.delete("room")
            document.location = url.toString();
          }
          state = new_state;
        }

        // Click to submit
        elements.submit.onclick = function() {
          let items = [];
          let rank = 0;
          for (let i = 0; i < elements.choices.children.length; i += 2) {
            let item = parseInt(elements.choices.children[i].dataset.choice_id);
            if (i != 0 && elements.choices.children[i - 1].textContent != "=") {
              rank++;
            }
            items.push({"candidate": item, "rank": rank});
          }
          ws.send(JSON.stringify({"vote": {"name": elements.voter_name.value, "selections": items}}))
        }

        elements.tally.onclick = function() {
          ws.send(JSON.stringify({"tally": null}));
        }
    }
  </script>
  <body onload="init()">
    <main class="container">
      <div hidden id="status">Not connected.</div>
      <form hidden id="setup" action="/start_vote" method="post">
        <label for="choices">Enter the choices up for vote, one per line:</label>
        <textarea name="choices"></textarea>
        <input type="submit" value="Start Vote">
      </form>
      <div hidden id="election">
        <p>Edit your ballot by clicking or dragging.</p>
        <div hidden id="choices">
        </div>
        <label for="voter_name">Voter name:</label>
        <input id="voter_name" value="???"></input>
        <button id="submit">Submit Your Vote</button>
        <div hidden id="your_vote_outer">You submitted: <span id="your_vote">N/A</span></div>
        <button hidden id="tally">Tally the Votes</button>
        <div id="submitted_outer"><span id="num_votes">0</span>/<span id="num_players">0</span> voters have submitted ballots.</div>
      </div>
      <article hidden id="results">
        <header>The results are in! The winner is: <strong><span id="winner">N/A</span></strong></header>
        <p> The votes are: </p>
        <ul id="votes"></ul>
        <table role="grid" id="defeats_matrix">
        </table>
      </article>
      <a hidden id="new" href="/vote.html">Create a new election.</a>
    </main>
  </body>
</html>

