<!DOCTYPE html>
<html>
  <head>
    <title>Rock Paper Scissors</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  </head>
  <script>
    function init() {
        var url = new URL(document.location);
        var room = url.searchParams.get('room');
        if (room == null) {
            room = crypto.randomUUID().substr(0, 5);
            url.searchParams.append('room', room);
            document.location = url.toString();
        }

        var elements = {};
        [
            "status", "num_players_outer", "history_outer", "choice_outer",
             "num_players", "history", "choice", "stats_outer", "wins",
             "losses", "draws", "buttons"
        ].forEach(
            name => {
                elements[name] = document.getElementById(name);
            }
        );
        elements.status = document.getElementById("status");
        elements.num_players_outer = document.getElementById("num_players_outer");

        const uri = 'ws://' + location.host + '/ws/' + room;
        const ws = new WebSocket(uri);
        var state = {"status": "connecting"};
        ws.onopen = function() {
            elements.status.innerHTML = '<p><em>Waiting for opponent...</em></p>';
        };
        ws.onclose = function() {
            if (state.status != "room_full") {
                state.status = "disconnected";
                elements.status.innerHTML = '<em>Disconnected from server! Try refreshing.</em>';
                elements.status.style.color = "red";
                elements.num_players_outer.hidden = true;
            }
        };
        ws.onmessage = function(msg) {
            const new_state = JSON.parse(msg.data);
            console.log(new_state);
            if (new_state.status == "room_full") {
                elements.status.innerHTML = "Failed to join: room is full!";
                return;
            } else if (new_state.status == "connected") {
                elements.status.innerHTML = "Connected!";
            }
            elements.num_players.innerHTML = new_state.room_state.num_players;
            elements.num_players_outer.hidden = false;
            elements.buttons.hidden = (new_state.room_state.num_players <= 1);
            if (new_state.room_state.history.length == 0) {
                elements.history_outer.hidden = true;
            } else {
                let history_info = "<ol>";
                new_state.room_state.history.forEach(item => {
                    history_info += `<li>${item.outcome}: ${item.choices[0]} vs ${item.choices[1]}</li>`
                });
                history_info += "</ol>";
                elements.history.innerHTML = history_info;
                elements.history_outer.hidden = false;
            }
            if (new_state.room_state.choice) {
                elements.choice.innerHTML = new_state.room_state.choice;
                elements.choice_outer.hidden = false;
            } else {
                elements.choice_outer.hidden = true;
            }
            if (new_state.room_state.wins || new_state.room_state.losses || new_state.room_state.draws) {
                elements.stats_outer.hidden = false;
                elements.wins.innerHTML = new_state.room_state.wins;
                elements.losses.innerHTML = new_state.room_state.losses;
                elements.draws.innerHTML = new_state.room_state.draws;
            } else {
                elements.stats_outer.hidden = true;
            }
            state = new_state;
        };
        ["rock", "paper", "scissors"].forEach(choice => {
            const button = document.getElementById(choice);
            button.onclick = function() {
                ws.send(JSON.stringify({"choice": choice}));
            };
        });
    }
  </script>
  <body onload="init()">
    <div id="buttons">
      <a href="#" role="button" id="rock">rock</a>
      <a href="#" role="button" id="paper">paper</a>
      <a href="#" role="button" id="scissors">scissors</a>
    </div>
    <div hidden id="choice_outer">You have selected: <span id="choice">N/A</span>.</div>
    <div id="status">Not connected.</div>
    <div hidden id="num_players_outer">There are <span id="num_players">0</span> players connected.</div>
    <div hidden id="stats_outer">Wins: <span id="wins">0</span> Losses: <span id="losses">0</span> Draws: <span id="draws">0</span></div>
    <div hidden id="history_outer">Game history:<span id="history"></span></div>
  </body>
</html>
