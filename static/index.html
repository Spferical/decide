<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      :root {
        color-scheme: light dark;
      }
      body{
        margin:40px auto;
        max-width:650px;
        line-height:1.6;
        font-size:18px;
        padding:0 10px
      }
      button{
        margin:40px auto;
        max-width:650px;
        line-height:1.6;
        font-size:18px;
        padding:0 10px
      }
      h1,
      h2,
      h3{
        line-height:1.2
      }
    </style>
  </head>
  <script>
    function init() {
        var elements = {};
        elements.buttons = {}
        elements.buttons = ["rock", "paper", "scissors"].map(
            name => document.getElementById(name)
        );
        [
            "status", "num_players_outer", "history_outer", "choice_outer",
             "num_players", "history", "choice", "stats_outer", "wins",
             "losses", "draws"
        ].forEach(
            name => {
                elements[name] = document.getElementById(name);
            }
        );
        elements.status = document.getElementById("status");
        elements.num_players_outer = document.getElementById("num_players_outer");

        const uri = 'ws://' + location.host + '/ws';
        const ws = new WebSocket(uri);
        var state = {"status": "connecting"};
        ws.onopen = function() {
            elements.status.innerHTML = '<p><em>Waiting for opponent...</em></p>';
        };
        ws.onclose = function() {
            if (state.status != "room_full") {
                state.status = "disconnected";
                elements.status.innerHTML = '<em>Disconnected from server! Try refreshing.</em>';
            }
        };
        ws.onmessage = function(msg) {
            const new_state = JSON.parse(msg.data);
            console.log(new_state);
            if (new_state.status == "room_full") {
                elements.status.innerHTML = "Failed to join: room is full!";
                return;
            } else if (new_state.status == "connected") {
                elements.status.innerHTML = "Connected!";
            }
            elements.num_players.innerHTML = new_state.room_state.num_players;
            elements.num_players_outer.hidden = false;
            if (new_state.room_state.history.length == 0) {
                elements.history_outer.hidden = true;
            } else {
                let history_info = "<ol>";
                new_state.room_state.history.forEach(item => {
                    history_info += `<li>${item.outcome}: ${item.choices[0]} vs ${item.choices[1]}</li>`
                });
                history_info += "</ol>";
                elements.history.innerHTML = history_info;
                elements.history_outer.hidden = false;
            }
            if (new_state.room_state.choice) {
                elements.choice.innerHTML = new_state.room_state.choice;
                elements.choice_outer.hidden = false;
            } else {
                elements.choice_outer.hidden = true;
            }
            if (new_state.room_state.wins || new_state.room_state.losses || new_state.room_state.draws) {
                elements.stats_outer.hidden = false;
                elements.wins.innerHTML = new_state.room_state.wins;
                elements.losses.innerHTML = new_state.room_state.losses;
                elements.draws.innerHTML = new_state.room_state.draws;
            } else {
                elements.stats_outer.hidden = true;
            }
            state = new_state;
        };
        ["rock", "paper", "scissors"].forEach(choice => {
            const button = document.getElementById(choice);
            button.onclick = function() {
                ws.send(JSON.stringify({"choice": choice}));
            };
        });
    }
  </script>
  <body onload="init()">
    <button type="button" id="rock">rock</button>
    <button id="paper">paper</button>
    <button id="scissors">scissors</button>
    <div hidden id="choice_outer">You have selected: <span id="choice">N/A</span>.</div>
    <div id="status">Not connected.</div>
    <div hidden id="num_players_outer">There are <span id="num_players">0</span> players connected.</div>
    <div hidden id="stats_outer">Wins: <span id="wins">0</span> Losses: <span id="losses">0</span> Draws: <span id="draws">0</span></div>
    <div hidden id="history_outer">Game history:<span id="history"></span></div>
  </body>
</html>
